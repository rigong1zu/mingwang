import{b5 as b,b6 as S,u as P,d as U,r as d,m as O,j as e,B as y,bd as ee,b9 as ae,n as re,Z as G,bC as R,bD as C,bE as le,bF as ce,bg as oe,bh as ie,bi as te,bj as de,X as K,I as N,bl as pe,bG as me,bH as he,bI as ue,bJ as W,L as xe,bs as M,b2 as T,bK as X,bL as J,bM as Q,bN as Y,bO as Z,bP as _,bQ as ye,bR as je,bS as ve,bT as ge,bU as fe,bV as we,bW as Ne,bX as Ce,bY as be,Y as Se,bZ as A,b_ as Te,i as ke,J as Me,K as _e,O as De,Q as Pe}from"./index.b12a37b1.js";import{T as Ie,a as Ee,b as q,c as p,d as He}from"./table.ee96bcb4.js";import{O as E}from"./OperationAction.af8e5ae6.js";import{g as Le,b as V,a as Ve,C as Ae,c as Oe,P as H,p as L}from"./hook.04a71eda.js";import{A as Re}from"./activity.591f45b2.js";import{S as Be}from"./settings-2.e91964a4.js";import{P as Fe,a as D,b as z,c as $e}from"./Paragraph.b0fc65ff.js";import{M as Ge}from"./multi-combobox.7321a305.js";async function Ke(){try{return(await b.get("/admin/channel/list")).data}catch(n){return{status:!1,error:S(n),data:[]}}}async function We(n){try{return(await b.get(`/admin/channel/get/${n}`)).data}catch(s){return{status:!1,error:S(s)}}}async function Xe(n){try{return(await b.post("/admin/channel/create",n)).data}catch(s){return{status:!1,error:S(s)}}}async function Je(n,s){try{return(await b.post(`/admin/channel/update/${n}`,s)).data}catch(r){return{status:!1,error:S(r)}}}async function Qe(n){try{return(await b.get(`/admin/channel/delete/${n}`)).data}catch(s){return{status:!1,error:S(s)}}}async function Ye(n){try{return(await b.get(`/admin/channel/activate/${n}`)).data}catch(s){return{status:!1,error:S(s)}}}async function Ze(n){try{return(await b.get(`/admin/channel/deactivate/${n}`)).data}catch(s){return{status:!1,error:S(s)}}}function qe({type:n}){const s=d.useMemo(()=>Le(n),[n]);return e.jsx(ce,{className:"select-none w-max cursor-pointer",children:s||n})}function ze({dispatch:n,open:s,setOpen:r}){const{t:c}=P(),{toast:o}=U(),[a,h]=d.useState("https://api.openai.com"),[x,w]=d.useState(""),g=async t=>{t=t.trim(),t.endsWith("/")&&(t=t.slice(0,-1));const u=await he(x,{endpoint:t});if(C(o,c,u,!0),!u.status)return!1;const i={id:-1,name:ue(t).replace(/\./g,"-"),type:"openai",models:u.data,priority:0,weight:1,retry:1,secret:x,endpoint:t,mapper:"",state:!0,group:[],proxy:{proxy:"",proxy_type:0,username:"",password:""}};return n({type:"set",value:i}),!0};return e.jsx(e.Fragment,{children:e.jsx(oe,{open:s,onOpenChange:r,children:e.jsxs(ie,{children:[e.jsx(te,{children:e.jsx(de,{children:c("admin.channels.joint")})}),e.jsxs("div",{className:"pt-2 flex flex-col",children:[e.jsxs("div",{className:"flex flex-row items-center mb-4",children:[e.jsx(K,{className:"mr-2 whitespace-nowrap",children:c("admin.channels.joint-endpoint")}),e.jsx(N,{value:a,onChange:t=>h(t.target.value),placeholder:c("admin.channels.upstream-endpoint-placeholder")})]}),e.jsxs("div",{className:"flex flex-row items-center",children:[e.jsx(K,{className:"mr-2 whitespace-nowrap",children:c("admin.channels.secret")}),e.jsx(N,{value:x,onChange:t=>w(t.target.value),placeholder:c("admin.channels.sync-secret-placeholder")})]})]}),e.jsxs(pe,{children:[e.jsx(me,{asChild:!0,children:e.jsx(y,{variant:"outline",children:c("cancel")})}),e.jsx(y,{className:"mb-1",onClick:async()=>{await g(a)&&r(!1)},children:c("confirm")})]})]})})})}function Ue({display:n,dispatch:s,setId:r,setEnabled:c}){const{t:o}=P(),{toast:a}=U(),[h,x]=d.useState([]),[w,g]=d.useState(!1),[t,u]=d.useState(!1),m=async()=>{g(!0);const i=await Ke();g(!1),i.status?x(i.data):C(a,o,i)};return O(m,[]),O(m,[n]),d.useEffect(()=>{n&&r(-1)},[n]),n&&e.jsxs("div",{children:[e.jsx(ze,{open:t,setOpen:u,dispatch:i=>{s(i),c(!0),r(-1)}}),e.jsxs("div",{className:"flex flex-row w-full h-max",children:[e.jsxs(y,{className:"mr-2",onClick:()=>{c(!0),r(-1)},children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),o("admin.channels.create")]}),e.jsxs(y,{className:"mr-2",variant:"outline",onClick:()=>u(!0),children:[e.jsx(Re,{className:"h-4 w-4 mr-1"}),o("admin.channels.joint")]}),e.jsx("div",{className:"grow"}),e.jsx(y,{variant:"outline",size:"icon",className:"mr-2",onClick:m,children:e.jsx(ae,{className:re("h-4 w-4",w&&"animate-spin")})})]}),e.jsxs(Ie,{className:"channel-table mt-4",children:[e.jsx(Ee,{children:e.jsxs(q,{className:"select-none whitespace-nowrap",children:[e.jsx(p,{children:o("admin.channels.id")}),e.jsx(p,{children:o("admin.channels.name")}),e.jsx(p,{children:o("admin.channels.type")}),e.jsx(p,{children:o("admin.channels.priority")}),e.jsx(p,{children:o("admin.channels.weight")}),e.jsx(p,{children:o("admin.channels.state")}),e.jsx(p,{children:o("admin.channels.action")})]})}),e.jsx(He,{children:(h||[]).map((i,k)=>e.jsxs(q,{children:[e.jsxs(p,{className:"channel-id select-none",children:["#",i.id]}),e.jsx(p,{children:i.name}),e.jsx(p,{children:e.jsx(qe,{type:i.type})}),e.jsx(p,{children:i.priority}),e.jsx(p,{children:i.weight}),e.jsx(p,{children:i.state?e.jsx(G,{className:"h-4 w-4 text-green-500"}):e.jsx(R,{className:"h-4 w-4 text-destructive"})}),e.jsxs(p,{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(E,{tooltip:o("admin.channels.edit"),onClick:()=>{c(!0),r(i.id)},children:e.jsx(Be,{className:"h-4 w-4"})}),i.state?e.jsx(E,{tooltip:o("admin.channels.disable"),variant:"destructive",onClick:async()=>{const j=await Ze(i.id);C(a,o,j,!0),await m()},children:e.jsx(R,{className:"h-4 w-4"})}):e.jsx(E,{tooltip:o("admin.channels.enable"),onClick:async()=>{const j=await Ye(i.id);C(a,o,j,!0),await m()},children:e.jsx(G,{className:"h-4 w-4"})}),e.jsx(E,{tooltip:o("admin.channels.delete"),variant:"destructive",onClick:async()=>{const j=await Qe(i.id);C(a,o,j,!0),await m()},children:e.jsx(le,{className:"h-4 w-4"})})]})]},k))})]})]})}function en({onPost:n}){const{t:s}=P(),[r,c]=d.useState("");function o(){const a=r.trim();a!==""&&(n(a),c(""))}return e.jsxs("div",{className:"flex flex-row grow gap-0 custom-action",children:[e.jsx(N,{value:r,placeholder:s("admin.channels.add-custom-model"),className:"rounded-r-none",onChange:a=>c(a.target.value),onKeyDown:a=>{ke(a)&&o()}}),e.jsx(y,{className:"rounded-l-none",onClick:o,children:s("add")})]})}function nn(n){return n.name.trim()!==""&&n.models.length>0&&n.secret.trim()!==""&&n.endpoint.trim()!==""}function sn(n){return n.models=n.models.filter(s=>s.trim()!==""),n.name=n.name.trim(),n.secret=n.secret.trim().split(`
`).filter(s=>s.trim()!=="").join(`
`),n.endpoint=n.endpoint.trim(),n.endpoint.endsWith("/")&&(n.endpoint=n.endpoint.slice(0,-1)),n.mapper=n.mapper.trim().split(`
`).filter(s=>{if(s.trim()==="")return!1;const r=s.split(">");return r.length===2&&r[0].trim()!==""&&r[1].trim()!==""}).join(`
`),n.group=n.group?n.group.filter(s=>s.trim()!==""):[],n.proxy&&n.proxy.proxy.trim()===""&&n.proxy.proxy_type!==0&&(n.proxy.proxy_type=0),n}function an({display:n,id:s,edit:r,dispatch:c,setEnabled:o}){var k,j,I,f,B,F,$;const{t:a}=P(),h=d.useMemo(()=>V(r.type),[r.type]),{channelModels:x}=Ve(),w=d.useMemo(()=>x.filter(l=>!r.models.includes(l)&&l!==""),[x,r.models]),g=d.useMemo(()=>nn(r),[r]),[t,u]=d.useState(!1);function m(l){l&&c({type:"clear"}),o(!1)}async function i(){const l=sn(r);console.debug("[channel] preflight channel data",l);const v=s===-1?await Xe(l):await Je(s,l);C(W,a,v,!0),v.status&&m(!0)}return O(async()=>{if(s===-1)c({type:"clear"});else{u(!0);const l=await We(s);u(!1),C(W,a,l),l.data&&c({type:"set",value:l.data})}},[s]),n&&e.jsxs("div",{className:"channel-editor",children:[t&&e.jsx(xe,{className:"channel-loader h-4 w-4 animate-spin"}),e.jsxs("div",{className:"channel-wrapper w-full h-max",children:[e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[e.jsx(M,{}),a("admin.channels.name"),e.jsx(T,{content:a("admin.channels.name-tip")})]}),e.jsx(N,{value:r.name,placeholder:a("admin.channels.name-placeholder"),onChange:l=>c({type:"name",value:l.target.value})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[e.jsx(M,{}),a("admin.channels.type")]}),e.jsxs(X,{value:r.type,onValueChange:l=>c({type:"type",value:l}),children:[e.jsx(J,{children:e.jsx(Q,{placeholder:a("admin.channels.type")})}),e.jsx(Y,{children:e.jsx(Z,{children:Object.entries(Ae).map(([l,v],se)=>e.jsx(_,{value:l,children:v},se))})})]}),h.description&&e.jsx(ye,{className:"channel-description mt-4 mb-1",children:h.description})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[e.jsx(M,{}),a("admin.channels.model")]}),e.jsx("div",{className:"channel-model-wrapper",children:r.models.map((l,v)=>e.jsxs("div",{className:"channel-model-item",children:[l,e.jsx(R,{className:"remove-action",onClick:()=>c({type:"remove-model",value:l})})]},v))}),e.jsxs("div",{className:"channel-model-action mt-4",children:[e.jsxs(je,{children:[e.jsx(ve,{asChild:!0,children:e.jsxs(y,{children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),a("admin.channels.add-model")]})}),e.jsx(fe,{align:"start",asChild:!0,children:e.jsxs(we,{children:[e.jsx(Ne,{placeholder:a("admin.channels.search-model")}),e.jsx(Ce,{className:"thin-scrollbar",children:w.map((l,v)=>e.jsx(be,{value:l,onSelect:()=>c({type:"add-model",value:l}),className:"px-2",children:l},v))})]})})]}),e.jsx(en,{onPost:l=>{const v=l.split(" ");c({type:"add-models",value:v})}}),e.jsx(y,{onClick:()=>c({type:"add-models",value:h.models}),children:a("admin.channels.fill-template-models",{number:h.models.length})}),e.jsx(y,{variant:"outline",onClick:()=>c({type:"clear-models"}),children:a("admin.channels.clear-models")})]})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[e.jsx(M,{}),a("admin.channels.secret")]}),e.jsx(Se,{value:r.secret,placeholder:a("admin.channels.secret-placeholder",{format:h.format}),onChange:l=>c({type:"secret",value:l.target.value})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[e.jsx(M,{}),a("admin.channels.endpoint")]}),e.jsx(N,{value:r.endpoint,placeholder:a("admin.channels.endpoint-placeholder"),onChange:l=>c({type:"endpoint",value:l.target.value})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[a("admin.channels.priority"),e.jsx(T,{content:a("admin.channels.priority-tip")})]}),e.jsx(A,{value:r.priority,acceptNegative:!0,onValueChange:l=>c({type:"priority",value:l})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[a("admin.channels.weight"),e.jsx(T,{content:a("admin.channels.weight-tip")})]}),e.jsx(A,{value:r.weight,min:1,onValueChange:l=>c({type:"weight",value:l})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[a("admin.channels.retry"),e.jsx(T,{content:a("admin.channels.retry-tip")})]}),e.jsx(A,{value:r.retry,min:1,onValueChange:l=>c({type:"retry",value:l})})]}),e.jsxs("div",{className:"channel-row",children:[e.jsxs("div",{className:"channel-content",children:[a("admin.channels.mapper"),e.jsx(T,{content:a("admin.channels.mapper-tip")})]}),e.jsx(Te,{rows:5,value:r.mapper,placeholder:a("admin.channels.mapper-placeholder"),onChange:l=>c({type:"mapper",value:l.target.value})})]}),e.jsxs(Fe,{title:a("admin.channels.advanced"),isCollapsed:!0,children:[e.jsx(D,{children:e.jsxs("div",{className:"channel-row column-layout",children:[e.jsxs("div",{className:"channel-content",children:[a("admin.channels.group"),e.jsx(T,{content:a("admin.channels.group-tip")})]}),e.jsx(Ge,{className:"w-full max-w-full",value:r.group||[],align:"end",onChange:l=>c({type:"set-group",value:l}),list:Oe,listTranslate:"admin.channels.groups",placeholder:a("admin.channels.group-placeholder",{length:(r.group||[]).length})})]})}),e.jsx(z,{children:a("admin.channels.group-desc")}),e.jsx($e,{}),e.jsx(D,{children:e.jsxs("div",{className:"channel-row column-layout",children:[e.jsx("div",{className:"channel-content",children:a("admin.channels.proxy-type")}),e.jsxs(X,{value:(((k=r.proxy)==null?void 0:k.proxy_type)||0).toString(),onValueChange:l=>c({type:"set-proxy-type",value:parseInt(l)}),children:[e.jsx(J,{children:e.jsx(Q,{})}),e.jsx(Y,{children:e.jsxs(Z,{children:[e.jsx(_,{value:"0",children:H[L.NoneProxy]}),e.jsx(_,{value:"1",children:H[L.HttpProxy]}),e.jsx(_,{value:"2",children:H[L.HttpsProxy]}),e.jsx(_,{value:"3",children:H[L.Socks5Proxy]})]})})]})]})}),e.jsxs(D,{children:[e.jsx("div",{className:"channel-content",children:a("admin.channels.proxy-endpoint")}),e.jsx(N,{value:((j=r.proxy)==null?void 0:j.proxy)||"",placeholder:a("admin.channels.proxy-endpoint-placeholder"),onChange:l=>c({type:"set-proxy",value:l.target.value}),disabled:((I=r.proxy)==null?void 0:I.proxy_type)===0})]}),e.jsxs(D,{children:[e.jsx("div",{className:"channel-content",children:a("admin.channels.proxy-username")}),e.jsx(N,{value:((f=r.proxy)==null?void 0:f.username)||"",placeholder:a("admin.channels.proxy-username-placeholder"),onChange:l=>c({type:"set-proxy-username",value:l.target.value}),disabled:((B=r.proxy)==null?void 0:B.proxy_type)===0})]}),e.jsxs(D,{children:[e.jsx("div",{className:"channel-content",children:a("admin.channels.proxy-password")}),e.jsx(N,{value:((F=r.proxy)==null?void 0:F.password)||"",placeholder:a("admin.channels.proxy-password-placeholder"),onChange:l=>c({type:"set-proxy-password",value:l.target.value}),disabled:(($=r.proxy)==null?void 0:$.proxy_type)===0})]}),e.jsx(z,{children:a("admin.channels.proxy-desc")})]})]}),e.jsxs("div",{className:"mt-4 flex flex-row w-full h-max pr-2 items-center",children:[e.jsxs("div",{className:"object-id",children:[e.jsx("span",{className:"mr-2",children:"ID"}),r.id===-1?e.jsx(ee,{className:"w-3 h-3"}):e.jsx("span",{className:"id",children:r.id})]}),e.jsx("div",{className:"grow"}),e.jsx(y,{variant:"outline",onClick:()=>m(),children:a("cancel")}),e.jsx(y,{className:"ml-2",loading:!0,onClick:i,disabled:!g,children:a("confirm")})]})]})}const rn={proxy:"",proxy_type:0,username:"",password:""},ne={id:-1,type:"openai",name:"",models:[],priority:0,weight:1,retry:1,secret:"",endpoint:V().endpoint,mapper:"",state:!0,group:[],proxy:{...rn}};function ln(n,s){var r,c,o,a,h,x,w,g,t,u,m,i;switch(s.type){case"type":const j=V(n.type).endpoint!==n.endpoint&&n.endpoint.trim()!==""?n.endpoint:V(s.value).endpoint;return{...n,endpoint:j,type:s.value};case"name":return{...n,name:s.value};case"models":return{...n,models:s.value};case"add-model":return n.models.includes(s.value)||s.value===""?n:{...n,models:[...n.models,s.value]};case"add-models":const I=s.value.filter(f=>!n.models.includes(f)&&f!=="");return{...n,models:[...n.models,...I]};case"remove-model":return{...n,models:n.models.filter(f=>f!==s.value)};case"clear-models":return{...n,models:[]};case"priority":return{...n,priority:s.value};case"weight":return{...n,weight:s.value};case"secret":return{...n,secret:s.value};case"endpoint":return{...n,endpoint:s.value};case"mapper":return{...n,mapper:s.value};case"retry":return{...n,retry:s.value};case"clear":return{...ne};case"add-group":return{...n,group:n.group?[...n.group,s.value]:[s.value]};case"remove-group":return{...n,group:n.group?n.group.filter(f=>f!==s.value):[]};case"set-group":return{...n,group:s.value};case"set-proxy":return{...n,proxy:{proxy:s.value,proxy_type:((r=n==null?void 0:n.proxy)==null?void 0:r.proxy_type)||0,password:((c=n==null?void 0:n.proxy)==null?void 0:c.password)||"",username:((o=n==null?void 0:n.proxy)==null?void 0:o.username)||""}};case"set-proxy-type":return{...n,proxy:{proxy:((a=n==null?void 0:n.proxy)==null?void 0:a.proxy)||"",proxy_type:s.value,password:((h=n==null?void 0:n.proxy)==null?void 0:h.password)||"",username:((x=n==null?void 0:n.proxy)==null?void 0:x.username)||""}};case"set-proxy-username":return{...n,proxy:{proxy:((w=n==null?void 0:n.proxy)==null?void 0:w.proxy)||"",proxy_type:((g=n==null?void 0:n.proxy)==null?void 0:g.proxy_type)||0,password:((t=n==null?void 0:n.proxy)==null?void 0:t.password)||"",username:s.value}};case"set-proxy-password":return{...n,proxy:{proxy:((u=n==null?void 0:n.proxy)==null?void 0:u.proxy)||"",proxy_type:((m=n==null?void 0:n.proxy)==null?void 0:m.proxy_type)||0,password:s.value,username:((i=n==null?void 0:n.proxy)==null?void 0:i.username)||""}};case"set":return{...n,...s.value};default:return n}}function cn(){const[n,s]=d.useState(!1),[r,c]=d.useState(-1),[o,a]=d.useReducer(ln,{...ne});return e.jsxs(e.Fragment,{children:[e.jsx(Ue,{setEnabled:s,setId:c,display:!n,dispatch:a}),e.jsx(an,{setEnabled:s,id:r,display:n,edit:o,dispatch:a})]})}function yn(){const{t:n}=P();return e.jsx("div",{className:"channel",children:e.jsxs(Me,{className:"admin-card channel-card",children:[e.jsx(_e,{className:"select-none",children:e.jsx(De,{children:n("admin.channel")})}),e.jsx(Pe,{children:e.jsx(cn,{})})]})})}export{yn as default};
